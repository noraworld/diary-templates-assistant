name: '17: ğŸ€ğŸ“† ç¿Œæ—¥ã‚„ã‚‹ã“ã¨æ•´ç†'

on:
  workflow_dispatch:
    inputs:
      target:
        required: true
        description: 'å¯¾è±¡'
        type: choice
        options:
          - ''
          - 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'
          - 'ä»•äº‹'
        default: ''
      arranged:
        required: true
        description: 'ç¾åœ¨ã®èª²é¡Œã‚’æ•´ç†'
        type: boolean
      remarks:
        required: false
        description: 'å‚™è€ƒ'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Pile
        run: |
          case "${{ github.event.inputs.target }}" in
            "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ")
              TEMPLATE_REPO="noraworld/diary-templates"
              TEMPLATE_FILE_REPO="noraworld/diary-templates-assistant"
              TEMPLATE_FILE_PATH=".github/ISSUE_TEMPLATE/pile.md"
              TASK_REPO="noraworld/to-do"
              SEARCH_QUERY="pile ç¿Œæ—¥ã‚„ã‚‹ã“ã¨æ•´ç†"
              ;;
            "ä»•äº‹")
              TEMPLATE_REPO="noraworld/daily-report-templates"
              TEMPLATE_FILE_REPO="noraworld/daily-report-templates"
              TEMPLATE_FILE_PATH=".github/ISSUE_TEMPLATE/pile.md"
              TASK_REPO="noraworld/work-scraps"
              SEARCH_QUERY="ç¿Œå–¶æ¥­æ—¥ã«ã‚„ã‚‹ã“ã¨æ•´ç†"
              ;;
            *)
              echo "ERROR: invalid target" >&2
              exit 1
              ;;
          esac

          template=$(gh api "/repos/$TEMPLATE_FILE_REPO/contents/$TEMPLATE_FILE_PATH" --jq .content |
                       base64 --decode |
                       awk '/^```/{f++; next} f==1' |
                       while IFS= read -r line; do
                         if [ "$line" = "<ã“ã“ã«ã‚„ã‚‹ã“ã¨ã‚’æŒ¿å…¥>" ]; then
                           gh issue list \
                             --repo $TASK_REPO \
                             --search "label:today,tomorrow" \
                             --json title,url \
                             --template '{{range.}}* [{{.title}}]({{.url}}){{"\r\n"}}{{end}}' |
                             tac
                         elif [ "$line" = "<ã“ã“ã«å‚™è€ƒã‚’æŒ¿å…¥>" ]; then
                           echo "${{ github.event.inputs.remarks || 'ç‰¹ã«ãªã—ã€‚' }}"
                         elif [ "$line" = "* [ ] ç¾åœ¨ã®èª²é¡Œã‚’æ•´ç†" ] && [ "${{ github.event.inputs.arranged }}" = "true" ]; then
                           echo "* [x] ç¾åœ¨ã®èª²é¡Œã‚’æ•´ç†"
                         else
                           echo "$line"
                         fi
                       done)

            issue_number=$(gh issue list \
                             --repo $TEMPLATE_REPO \
                             --search "$SEARCH_QUERY" |
                             awk '{ print $1 }')

            gh issue comment "$issue_number" \
              --repo $TEMPLATE_REPO \
              --body "$template"
        shell: sh
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
