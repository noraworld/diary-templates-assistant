name: '19-1: üçÄüìÜ ÁøåÊó•„ÇÑ„Çã„Åì„Å®Êï¥ÁêÜ'

on:
  workflow_dispatch:
    inputs:
      target:
        required: true
        description: 'ÂØæË±°'
        type: choice
        options:
          - ''
          - '„Éó„É©„Ç§„Éô„Éº„Éà'
          - '‰ªï‰∫ã'
        default: ''
      remarks:
        required: false
        description: 'ÂÇôËÄÉ'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Pile
        run: |
          case "${{ github.event.inputs.target }}" in
            "„Éó„É©„Ç§„Éô„Éº„Éà")
              TEMPLATE_REPO="noraworld/diary-templates"
              TEMPLATE_FILE_REPO="noraworld/diary-templates-assistant"
              TEMPLATE_FILE_PATH=".github/ISSUE_TEMPLATE/pile.md"
              TASK_REPO="noraworld/to-do"
              SEARCH_QUERY="pile ÁøåÊó•„ÇÑ„Çã„Åì„Å®Êï¥ÁêÜ"
              ;;
            "‰ªï‰∫ã")
              TEMPLATE_REPO="noraworld/daily-report-templates"
              TEMPLATE_FILE_REPO="noraworld/daily-report-templates"
              TEMPLATE_FILE_PATH=".github/ISSUE_TEMPLATE/pile.md"
              TASK_REPO="noraworld/work-scraps"
              SEARCH_QUERY="ÁøåÂñ∂Ê•≠Êó•„Å´„ÇÑ„Çã„Åì„Å®Êï¥ÁêÜ"
              ;;
            *)
              echo "ERROR: invalid target" >&2
              exit 1
              ;;
          esac

          template=$(gh api "/repos/$TEMPLATE_FILE_REPO/contents/$TEMPLATE_FILE_PATH" --jq .content |
                       base64 --decode |
                       awk '/^```/{f++; next} f==1' |
                       while IFS= read -r line; do
                         if [ "$line" = "<„Åì„Åì„Å´„ÇÑ„Çã„Åì„Å®„ÇíÊåøÂÖ•>" ]; then
                           gh issue list \
                             --repo $TASK_REPO \
                             --search "label:today,tomorrow" \
                             --json title,url \
                             --template '{{range.}}* [{{.title}}]({{.url}}){{"\r\n"}}{{end}}' |
                             tac
                         elif [ "$line" = "<„Åì„Åì„Å´ÂÇôËÄÉ„ÇíÊåøÂÖ•>" ]; then
                           echo "${{ github.event.inputs.remarks || 'Áâπ„Å´„Å™„Åó„ÄÇ' }}"
                         else
                           echo "$line"
                         fi
                       done)

            issue_number=$(gh issue list \
                             --repo $TEMPLATE_REPO \
                             --search "$SEARCH_QUERY" |
                             awk '{ print $1 }')

            gh issue comment "$issue_number" \
              --repo $TEMPLATE_REPO \
              --body "$template"
        shell: sh
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
