name: Auto Check-off

on:
  workflow_call:
    inputs:
      main_repo:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  check:
    # https://stackoverflow.com/questions/59588605/how-to-check-for-a-label-in-a-github-action-condition#answer-59588725
    # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/evaluate-expressions-in-workflows-and-actions#example-using-an-object-filter
    if: >
      github.event.issue.state == 'open'                       &&
      !contains(github.event.issue.labels.*.name, 'abandoned') &&
      !contains(github.event.issue.labels.*.name, 'achieved')  &&
      !contains(github.event.issue.labels.*.name, 'done')
    runs-on: ubuntu-latest
    steps:
      # "2024-03-05_sleep_睡眠記録" => "睡眠記録"
      - name: Get a title
        run: echo "TITLE=$(cut -d '_' -f3 <<< "${{ github.event.issue.title }}")" >> $GITHUB_ENV

      - name: Check if off
        run: |
          NUMBER=$(
            gh issue list         \
              --repo "$MAIN_REPO" \
              --limit 1           |
              awk '{ print $1 }'
          )
          BODY=$(
            gh issue view         \
              --repo "$MAIN_REPO" \
              --json body         \
              --jq .body          \
              "$NUMBER"
          )
          BODY_WITH_CHECKED_TASK=$(
            echo "$BODY" |
            sed -E "s/^\* \[ \] \[$TITLE/\* \[x\] \[$TITLE/g"
          )

          if [ "$BODY" != "$BODY_WITH_CHECKED_TASK" ]; then
            gh issue edit --repo "$MAIN_REPO" --body "$BODY_WITH_CHECKED_TASK" "$NUMBER"
          else
            BODY_WITH_OPTIONAL_TASK=$(
              echo "$BODY" |
              awk '
              /### ✨ 任意/ {
                  print;
                  process_next = 1;
                  next;
              }
              process_next {
                  if ($0 ~ /\* \[[x| ]\] \[(.*)\]\((.*)\)/) {
                      print;
                      insert = "* [x] [" ENVIRON["TITLE"] "](${{ github.event.issue.html_url }})";

                      while (getline > 0) {
                          if ($0 ~ /\* \[[x| ]\] \[(.*)\]\((.*)\)/) {
                              print;
                          } else {
                              print insert;
                              print;
                              break;
                          }
                      }
                  } else if (/特になし/) {
                      $0 = "* [x] [" ENVIRON["TITLE"] "](${{ github.event.issue.html_url }})";
                      print;
                  } else {
                      print;
                  }
                  process_next = 0;
                  next;
              }
              { print }'
            )

            gh issue edit --repo "$MAIN_REPO" --body "$BODY_WITH_OPTIONAL_TASK" "$NUMBER"
          fi
        shell: sh
        env:
          MAIN_REPO: ${{ inputs.main_repo }}
          GH_TOKEN: ${{ secrets.token }}

  label:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Add the label
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-label 'achieved'
        shell: sh
        env:
          GH_TOKEN: ${{ secrets.token }}
