name: Issue Recorder

on:
  workflow_call:
    secrets:
      token:
        required: true

jobs:
  build:
    if: >
      github.event.issue.state == 'open' &&
      github.event.label.name == 'done'
    runs-on: ubuntu-latest
    steps:
      - name: Retrieve the title prefix
        run: |
          # https://zenn.dev/link/comments/ac4003f2728de7
          # https://stackoverflow.com/questions/59588605/how-to-check-for-a-label-in-a-github-action-condition#answer-59588725
          if [ "$(echo "${{ toJson(github.event.issue.labels.*.name) }}" | grep -c "abandoned")" -gt 0 ]; then
            echo "TITLE_PREFIX=üòû" >> $GITHUB_ENV
          else
            echo "TITLE_PREFIX=‚úÖ" >> $GITHUB_ENV
          fi

      - name: Retrieve whether to skip body or not
        run: |
          if [ "$(echo "${{ toJson(github.event.issue.labels.*.name) }}" | grep -c "skip-body")" -gt 0 ]; then
            echo "SKIP_BODY=file, issue" >> $GITHUB_ENV
          else
            echo "SKIP_BODY=" >> $GITHUB_ENV
          fi

      - name: Get diary title
        run: echo "DIARY_TITLE=$(gh issue list --repo "noraworld/reserved-diary" --limit 1 | awk '{ print $3 }')" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Get year
        run: echo "YEAR=$(cut -d '-' -f1 <<< ${{ env.DIARY_TITLE }})" >> $GITHUB_ENV

      - name: Get month
        run: echo "MONTH=$(cut -d '-' -f2 <<< ${{ env.DIARY_TITLE }})" >> $GITHUB_ENV

      - name: Get day
        run: echo "DAY=$(cut -d '-' -f3 <<< ${{ env.DIARY_TITLE }})" >> $GITHUB_ENV

      - name: Track issues
        uses: noraworld/issue-recorder@main
        with:
          mode: "file, issue"
          filepath: default
          committer_name: Kosuke Aoki
          committer_email: mail@noraworld.com
          overwrite_when_modified: true
          extra_text_when_modified: "# ÈáçË§áÊäïÁ®øÔºÅ"
          notification_comment: "[`<FILE_PATH>`](<FILE_URL_WITH_SHA>) ([<REF_NAME>](<FILE_URL>))"
          title_prefix_for_file: ${{ env.TITLE_PREFIX }}
          target_issue_repo: noraworld/daily-report
          target_issue_number: latest
          fold_threshold: infinity
          # THE ASSETS SHOULD NEVER BE PUBLIC
          with_repo_assets: "file, issue"
          assets_repo_gist_id: f14aef1d07a99eb7922318d91aca03fc
          assets_directory: ${{ env.YEAR }}/${{ env.MONTH }}/${{ env.DAY }}
          with_assets_compression: true
          compression_threshold: 1048576
          resize_width: 1920
          with_compatible_format: true
          # THE ASSETS SHOULD NEVER BE PUBLIC
          fold_summary: Ë©≥Á¥∞„ÇíË°®Á§∫
          title_prefix_for_issue: ${{ env.TITLE_PREFIX }}
          with_date: true
          timezone: Asia/Tokyo
          time_format: h:mm a ¬∑ MMM d, yyyy (ZZZZ)
          with_header: "---\r\nnumber: <NUMBER>\r\ntitle: <TITLE>\r\nassignees: <ASSIGNEES>\r\nlabels: <LABELS>\r\ncreated_at: <CREATED_AT>\r\n---"
          with_title: "file, issue"
          # with_quote: issue
          skip_body: ${{ env.SKIP_BODY }}
          personal_access_token: GH_TOKEN
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Pile up today's to-do list on daily report's issue
        run: |
          NUMBER=$(gh issue list --repo "noraworld/daily-report" --limit 1 | awk '{ print $1 }')
          body=$(gh issue view --repo "noraworld/daily-report" --json body --jq .body "$NUMBER")
          processed_body=$(echo "$body" | sed -E 's/\* Áâπ„Å´„Å™„Åó//g')

          # It works:
          #   https://chat.openai.com/share/72f96556-1e59-4711-9a47-3eed72b8b184 (ja)
          #   https://chat.openai.com/share/1e516c7f-0382-4361-89c1-9be185bd7fb2 (ja)
          #
          # It doesn't work for some reason:
          #   https://hkobayash.hatenadiary.org/entry/20111106/1320560290 (ja)
          #
          ESCAPED_TITLE=$( echo "$TITLE" | sed 's/[^^]/[&]/g; s/\^/\\^/g; s/\[\[/\[\\[/g; s/\]\]/\]\\]/g' )
          ESCAPED_URL=$(   echo "$URL"   | sed 's/[^^]/[&]/g; s/\^/\\^/g' )

          # Do not indent inside the condition.
          if [ "$(echo "$processed_body" | grep -cE "\[$ESCAPED_TITLE\]\($ESCAPED_URL\)")" -eq 0 ]; then
          gh issue edit --repo "noraworld/daily-report" --body "$processed_body
          * [x] [$TITLE]($URL)
          " "$NUMBER"
          else
          NEW_BODY=$( echo "$processed_body" | sed -E "s/\* \[ \] (\[$ESCAPED_TITLE\]\($ESCAPED_URL\))/\* \[x\] \1/g" )
          gh issue edit --repo "noraworld/daily-report" --body "$NEW_BODY" "$NUMBER"
          fi
        shell: sh
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          TITLE: ${{ github.event.issue.title }}
          URL: ${{ github.event.issue.html_url }}

      - name: Close the issue
        run: gh issue close ${{ github.event.issue.number }}
        shell: sh
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
